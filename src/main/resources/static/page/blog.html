<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta content='tms,chat,wiki,translation,blog,markdown,group,team,teamwork,聊天,沟通,知识库,博文,国际化翻译,团队协作' name='Keywords'>
    <meta content='TMS是免费开源的团队协作(团队沟通,博文知识库,国际化翻译i18n)web系统(响应式界面设计,移动端适配).' name='Description'>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <title>TMS博文</title>
    <!-- Include CSS for icons. -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.min.css">
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet" type="text/css" /> -->
    <link href="froala_editor.pkgd.min.css" rel="stylesheet" type="text/css" />
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/froala-editor/2.8.4/css/froala_editor.pkgd.min.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/froala-editor/2.8.4/css/froala_style.min.css" rel="stylesheet" type="text/css" /> -->
    <link href="froala_style.min.css" rel="stylesheet" type="text/css" />
    <style>
    body {
        text-align: center;
    }

    div#editor {
        width: 81%;
        margin: auto;
        text-align: left;
        position: relative;
    }

    .ss {
        background-color: red;
    }

    .fr-wrapper>div[style*='z-index: 9999'] {
        /*position: absolute;
        top: -10000px;
        opacity: 0;*/
        display: none;
    }

    .fr-placeholder {
        margin-top: 1px!important;
    }

    .topbar {
        position: absolute;
        top: -50px;
    }

    .topbar>input {
        width: 300px;
        font-size: 26px;
    }

    .topbar>button {
        font-size: 18px;
        position: relative;
        top: -4px;
    }

    </style>
</head>

<body>
    <div id="editor">
        <div class="topbar">
            <input id="title" type="text" placeholder="标题">
            <button id="save">保存</button>
            <span id="msg" style="color: red; padding-left: 16px;"></span>
        </div>
        <div id='edit' style="margin-top: 60px;"></div>
    </div>
    <!-- Include jQuery lib. -->
    <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> -->
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/mode/xml/xml.min.js"></script>
    <!-- Include Editor JS files. -->
    <script type="text/javascript" src="froala_editor.pkgd.min.js"></script>
    <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/froala-editor/2.8.4/js/froala_editor.pkgd.min.js"></script> -->
    <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/froala-editor/2.8.4/js/languages/zh_cn.js"></script> -->
    <script>
    $(function() {

        var blog = null;

        $('#edit').froalaEditor({
                // enter: $.FroalaEditor.ENTER_BR,
                enter: $.FroalaEditor.ENTER_DIV,
                language: 'zh_cn',
                fileMaxSize: 1024 * 1024 * 10,
                imageUploadURL: '/admin/file/upload/img',
                imageUploadParams: {
                    toType: 'Blog'
                },
                fileUploadURL: '/admin/file/upload/file',
                fileUploadParams: {
                    toType: 'Blog'
                },
                imageManagerLoadURL: '/admin/file/upload/img/list',
                imageManagerDeleteURL: "/admin/file/upload/img/remove",
                imageManagerDeleteMethod: "POST"
            }) // Catch image removal from the editor.
            .on('froalaEditor.image.removed', function(e, editor, $img) {
                $.ajax({
                        method: "POST",
                        url: "/admin/file/upload/img/remove",
                        data: {
                            src: $img.attr('src')
                        }
                    })
                    .done(function(data) {
                        console.log('image was deleted');
                    })
                    .fail(function(err) {
                        console.log('image delete problem: ' + JSON.stringify(err));
                    });
            })
            // Catch image removal from the editor.
            .on('froalaEditor.file.unlink', function(e, editor, link) {
                $.ajax({
                        method: "POST",
                        url: "/admin/file/upload/file/remove",
                        data: {
                            src: link.getAttribute('href')
                        }
                    })
                    .done(function(data) {
                        console.log('file was deleted');
                    })
                    .fail(function(err) {
                        console.log('file delete problem: ' + JSON.stringify(err));
                    });
            });

        var query = location.search;
        if (query) {
            let arr = query.split('id=');
            if (arr.length == 2) {
                $.get('admin/blog/get', { id: arr[1] }, function(data) {
                    if (data.success) {
                        blog = data.data;
                        $('#title').val(blog.title);
                        $('#edit').froalaEditor('html.set', blog.content);
                    }
                });
            }
        }

        $('#save').click(function(event) {

            var title = $('#title').val();
            var content = $('#edit').froalaEditor('html.get', true);

            if (!title || !$.trim(title)) {
                alert('博文标题不能为空！');
                return;
            }

            if (!content || !$.trim(content)) {
                alert('博文内容不能为空！');
                return;
            }

            if (blog == null) {
                $.post('/admin/blog/create', {
                    url: location.protocol + '//' + location.host + '/page/index.html',
                    // usernames: '',
                    // spaceId: '',
                    title: title,
                    content: content,
                    privated: true,
                    contentHtml: content
                }, function(data, textStatus, xhr) {
                    if (data.success) {
                        blog = data.data;
                        // alert('博文保存成功！');
                        $('#msg').html('博文保存成功！');
                    } else {
                        // alert('博文保存失败！');
                        $('#msg').html('博文保存失败！【' + data.data + '】');
                    }
                });
            } else {
                $.post('/admin/blog/update', {
                    url: location.protocol + '//' + location.host + '/page/index.html',
                    id: blog.id,
                    version: blog.version,
                    // usernames: '',
                    // diff: ''
                    title: title,
                    content: content
                }, function(data, textStatus, xhr) {
                    if (data.success) {
                        blog = data.data;
                        // alert('博文更新成功！');
                        $('#msg').html('博文更新成功！');
                    } else {
                        // alert('博文更新失败！');
                        $('#msg').html('博文更新失败！【' + data.data + '】');
                    }
                });
            }
        });
    });

    </script>
</body>

</html>
